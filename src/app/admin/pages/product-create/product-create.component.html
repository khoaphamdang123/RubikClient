<section class="create-user-shell create-product-shell">
  <header class="page-header glass">
    <div>
      <p class="eyebrow">New product</p>
      <h1>Add catalog item</h1>
      <p>Mirror the admin API requirements for name, description, avatar, and feature so the request never bounces.</p>
    </div>

    <div class="header-actions">
      <button type="button" class="ghost-btn" (click)="prefillDemoProduct()" aria-label="Prefill demo product">
        Prefill demo data
      </button>
      <button type="button" class="ghost-btn" (click)="resetForm()" aria-label="Reset form">
        Reset form
      </button>
      <button type="button" class="back-btn" (click)="goBack()">
        Back to products
      </button>
    </div>
  </header>

  <div class="content-grid">
    <form class="create-form glass" [formGroup]="createForm" (ngSubmit)="submit()" novalidate>
      <div
        class="form-progress"
        role="progressbar"
        [attr.aria-valuenow]="completionPercent"
        aria-valuemin="0"
        aria-valuemax="100">
        <div class="form-progress-bar" [style.width.%]="completionPercent"></div>
        <span>{{ completionPercent }}% complete</span>
      </div>

      <section class="form-panel">
        <div class="panel-header">
          <div>
            <p class="section-eyebrow">Server required</p>
            <h2>Product essentials</h2>
            <p>The API trims whitespace and requires these fields before persisting the record.</p>
          </div>
        </div>

        <div class="fields-grid two-col">
          <div class="form-field">
            <label>Product name <span>*</span></label>
            <input type="text" formControlName="name" placeholder="Velocity Pro Cube" autocomplete="off" />
            <p class="field-hint">Must be unique. Backend compares using case-insensitive exact match.</p>
            <div class="field-error" *ngIf="controlInvalid('name')">
              {{ controlErrorMessage('name') }}
            </div>
          </div>

          <div class="form-field">
            <label>Hero feature <span>*</span></label>
            <input type="text" formControlName="feature" placeholder="Magnetic core · Frosted surface" />
            <p class="field-hint">Server stores this as <code>feature</code> (singular) even if legacy UI shows “features”.</p>
            <div class="field-error" *ngIf="controlInvalid('feature')">
              {{ controlErrorMessage('feature') }}
            </div>
          </div>
        </div>

        <div class="fields-grid">
          <div class="form-field full-width">
            <label>Description <span>*</span></label>
            <textarea
              class="description-input"
              formControlName="description"
              placeholder="Tell buyers what makes this cube special"
              rows="4"></textarea>
            <p class="field-hint">Backend rejects empty or whitespace-only descriptions.</p>
            <div class="field-error" *ngIf="controlInvalid('description')">
              {{ controlErrorMessage('description') }}
            </div>
          </div>
        </div>
      </section>

      <section class="form-panel">
        <div class="panel-header">
          <div>
            <p class="section-eyebrow">Media</p>
            <h2>Avatar or product image</h2>
            <p>Provide a URL or upload a local file. API stores the final string in <code>avatar</code>.</p>
          </div>
        </div>

        <div class="avatar-mode-toggle" role="tablist">
          <button
            type="button"
            role="tab"
            [class.active]="avatarInputMode === 'url'"
            (click)="setAvatarInputMode('url')">
            Use image URL
          </button>
          <button
            type="button"
            role="tab"
            [class.active]="avatarInputMode === 'upload'"
            (click)="setAvatarInputMode('upload')">
            Upload from device
          </button>
        </div>

        <div class="avatar-url" *ngIf="avatarInputMode === 'url'">
          <div class="form-field full-width">
            <label>Image URL <span>*</span></label>
            <input
              type="url"
              formControlName="avatar"
              placeholder="https://cdn.example.com/products/velocity.png"
              (input)="onAvatarUrlInput()" />
            <div class="avatar-suggestions">
              <span>Quick pick:</span>
              <button
                type="button"
                class="avatar-chip"
                *ngFor="let avatar of avatarSuggestions"
                (click)="useAvatarSuggestion(avatar)">
                <img [src]="avatar" alt="Avatar suggestion" />
              </button>
            </div>
            <div class="field-error" *ngIf="controlInvalid('avatar')">
              {{ controlErrorMessage('avatar') }}
            </div>
          </div>
        </div>

        <div class="avatar-upload" *ngIf="avatarInputMode === 'upload'">
          <input
            #avatarInput
            type="file"
            accept="image/png, image/jpeg, image/webp"
            (change)="onAvatarFileChange($event)"
            hidden />
          <label
            class="upload-drop"
            [class.active]="isAvatarDropActive"
            (click)="openAvatarPicker(avatarInput)"
            (dragenter)="onAvatarDragEnter($event)"
            (dragover)="onAvatarDragOver($event)"
            (dragleave)="onAvatarDragLeave($event)"
            (drop)="onAvatarDrop($event)">
            <div class="upload-preview">
              <img [src]="avatarPreview" alt="Product image preview" (error)="handleAvatarError($event)" />
            </div>
            <div class="upload-copy">
              <strong>Drop an image or click to browse</strong>
              <p>PNG, JPG or WEBP · up to {{ maxAvatarSizeMb }} MB</p>
              <span *ngIf="avatarFileName">{{ avatarFileName }} ready to upload</span>
            </div>
          </label>
          <div class="upload-controls">
            <button type="button" class="ghost-btn" (click)="openAvatarPicker(avatarInput)">Choose file</button>
            <button
              type="button"
              class="ghost-btn danger"
              (click)="clearAvatarSelection()"
              [disabled]="!createForm.get('avatar')?.value">
              Clear selection
            </button>
          </div>
          <p class="field-error" *ngIf="avatarUploadError">{{ avatarUploadError }}</p>
        </div>
      </section>

      <section class="form-panel">
        <div class="panel-header">
          <div>
            <p class="section-eyebrow">Optional</p>
            <h2>Category metadata</h2>
            <p>Provide a numeric category ID to group the product. Leave blank to skip.</p>
          </div>
        </div>

        <div class="fields-grid two-col">
          <div class="form-field">
            <label>Category ID</label>
            <input type="text" formControlName="category_id" placeholder="101" inputmode="numeric" />
            <p class="field-hint">Server expects an integer. We validate before submitting.</p>
            <div class="field-error" *ngIf="controlInvalid('category_id')">
              {{ controlErrorMessage('category_id') }}
            </div>
          </div>
        </div>

        <div class="api-guidance">
          <strong>API validation summary</strong>
          <ul class="rule-list">
            <li>Name, description, avatar, and feature are required (HTTP 400 if missing)</li>
            <li>Duplicates respond with HTTP 409 “Product name already exists”</li>
            <li><code>category_id</code> must be an integer if provided</li>
          </ul>
        </div>
      </section>

      <div class="form-alert error" *ngIf="serverError">
        {{ serverError }}
      </div>
      <div class="form-alert success" *ngIf="serverMessage">
        {{ serverMessage }}
        <span *ngIf="lastCreatedAt"> · {{ lastCreatedAt | date: 'shortTime' }}</span>
      </div>

      <footer class="form-actions">
        <button type="button" class="ghost-btn" (click)="goBack()">
          Cancel
        </button>
        <button type="submit" class="primary-btn" [disabled]="isSubmitting || createForm.invalid">
          {{ isSubmitting ? 'Creating product...' : 'Create product' }}
        </button>
      </footer>
    </form>

    <aside class="insights-panel">
      <div class="preview-card glass">
        <div class="preview-header">
          <p class="eyebrow">Live preview</p>
          <span class="status-chip">Catalog</span>
        </div>
        <div class="preview-body">
          <img
            [src]="avatarPreview"
            alt="Product preview"
            (error)="handleAvatarError($event)" />
          <div>
            <h3>{{ createForm.get('name')?.value || 'New product' }}</h3>
            <p>{{ createForm.get('feature')?.value || 'Feature pending' }}</p>
            <div class="mini-tags">
              <span>{{ createForm.get('category_id')?.value || 'No category' }}</span>
              <span>{{ createForm.get('description')?.value ? 'Description ready' : 'Description TBD' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="status-card glass">
        <div class="status-row">
          <span>Completion</span>
          <strong>{{ completionPercent }}%</strong>
        </div>
        <div class="progress-track">
          <div class="progress-fill" [style.width.%]="completionPercent"></div>
        </div>

        <div class="status-row">
          <span>Last created</span>
          <strong>{{ createdProductName || '—' }}</strong>
        </div>
        <div class="status-row">
          <span>API policy</span>
          <strong>All four core fields required</strong>
        </div>
      </div>
    </aside>
  </div>
</section>

