<div class="product-edit-shell">
  <div class="page-header glass">
    <div class="breadcrumbs">
      <button type="button" class="back-link" (click)="goBack()">← Back to products</button>
      <span>/</span>
      <span>Edit product</span>
    </div>
    <div class="header-main">
      <div>
        <p class="eyebrow">Product management</p>
        <h1>Edit {{ productData?.name || 'product' }}</h1>
        <p>Review product details, update information, and keep this product up to date.</p>
        <div class="quick-meta">
          <div>
            <span>Product ID</span>
            <strong>{{ productData?._id || productData?.id || '—' }}</strong>
          </div>
          <div>
            <span>Product name</span>
            <strong>{{ productData?.name || productForm.value.name || 'Name pending' }}</strong>
          </div>
          <div>
            <span>Last sync</span>
            <strong>{{ lastSyncedAt ? (lastSyncedAt | date: 'short') : 'Just now' }}</strong>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button
          type="button"
          class="btn ghost"
          (click)="resetChanges()"
          [disabled]="disableReset">
          Reset
        </button>
        <button
          type="button"
          class="btn primary"
          (click)="saveChanges()"
          [disabled]="disableSave">
          <span *ngIf="!isSaving">Save changes</span>
          <span *ngIf="isSaving">Saving…</span>          
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="state-card glass">
    <div class="loader"></div>
    <p>Loading product details…</p>
  </div>

  <div *ngIf="loadError && !isLoading" class="state-card glass error">
    <p>{{ loadError }}</p>
    <button type="button" class="btn primary" (click)="fetchProduct()">Try again</button>
  </div>

  <div *ngIf="!isLoading && !loadError" class="content-grid">
    <div class="server-summary glass" *ngIf="serverMessage">
      <div>
        <p class="eyebrow">Server response</p>
        <h2>{{ serverMessage }}</h2>
        <p>The latest snapshot was pulled from the admin API.</p>
      </div>
      <div class="server-meta">
        <div>
          <span>Last sync</span>
          <strong>{{ lastSyncedAt ? (lastSyncedAt | date: 'medium') : 'Just now' }}</strong>
        </div>
        <div>
          <span>Product ID</span>
          <strong>{{ productData?._id || productData?.id || 'Unknown' }}</strong>
        </div>
      </div>
    </div>
    <section class="form-panel glass">
      <form [formGroup]="productForm" (ngSubmit)="saveChanges()" novalidate>
        <div class="form-section">
          <div class="section-heading">
            <div>
              <p class="eyebrow">Product</p>
              <h2>Basic information</h2>
              <p>Visible across the admin and client experiences.</p>
            </div>
          </div>
          <div class="field-grid two">
            <label class="form-field">
              <span>Product name</span>
              <input type="text" formControlName="name" placeholder="Enter product name" />
              <small *ngIf="controlInvalid('name')">
                Product name is required.
              </small>
            </label>

            <label class="form-field">
              <span>Product image URL</span>
              <input type="url" formControlName="avatar" placeholder="https://…" (input)="onAvatarUrlInput()" />
              <small *ngIf="controlInvalid('avatar')">Provide a valid image URL.</small>
            </label>
          </div>

          <div class="field-grid one">
            <label class="form-field">
              <span>Description</span>
              <textarea
                class="description-input"
                formControlName="description"
                placeholder="Enter product description"
                rows="4"></textarea>
              <small *ngIf="controlInvalid('description')">Description is required.</small>
            </label>
          </div>

          <div class="field-grid one">
            <label class="form-field">
              <span>Features</span>
              <textarea
                formControlName="features"
                placeholder="Enter product features (optional)"
                rows="4"></textarea>
              <small>Additional product features or specifications.</small>
            </label>
          </div>

          <div class="field-grid one">
            <label class="form-field">
              <span>Edit category</span>
              <select formControlName="category_id">
                <option [ngValue]="''">No category</option>
                <option
                  *ngFor="let category of categories"
                  [ngValue]="category._id">
                  {{ category.category_name }}
                </option>
              </select>
              <small>
                Choose a category to associate this product with. We’ll submit its internal ID to the API.
              </small>
              <small *ngIf="isLoadingCategories">Loading categories…</small>
              <small class="error" *ngIf="categoriesError">{{ categoriesError }}</small>
            </label>
          </div>

          <div class="avatar-designer glass">
            <div class="avatar-designer-head">
              <div>
                <p class="eyebrow">Product image</p>
                <h3>Update product image</h3>
                <p>Drag in a new image or browse your device. We'll preview it instantly.</p>
              </div>
            </div>
            <input
              type="file"
              #avatarInput
              id="avatarInput"
              accept="image/*"
              (change)="onAvatarFileChange($event)"
              hidden />
            <label
              class="upload-drop"
              [class.active]="isAvatarDropActive"
              [class.error]="avatarUploadError"
              for="avatarInput"
              role="button"
              tabindex="0"
              (dragenter)="onAvatarDragEnter($event)"
              (dragover)="onAvatarDragOver($event)"
              (dragleave)="onAvatarDragLeave($event)"
              (drop)="onAvatarDrop($event)">
              <div class="upload-preview">
                <img [src]="avatarPreview" alt="Product image preview" (error)="onAvatarError($event)" />
              </div>
              <div class="upload-copy">
                <strong>Drop an image or click to browse</strong>
                <p>PNG, JPG or WEBP · up to {{ maxAvatarSizeMb }} MB</p>
                <span class="file-name" *ngIf="avatarFileName">Selected: {{ avatarFileName }}</span>
              </div>
            </label>
            <div class="upload-controls">
              <button type="button" class="btn ghost" (click)="clearAvatarSelection()">
                Use saved image
              </button>
              <button type="button" class="btn outline" (click)="openAvatarPicker(avatarInput)">
                Upload from device
              </button>
            </div>
            <small class="error" *ngIf="avatarUploadError">{{ avatarUploadError }}</small>
          </div>
        </div>

        <div class="form-actions mobile">
          <button
            type="button"
            class="btn ghost"
            (click)="resetChanges()"
            [disabled]="disableReset">
            Reset
          </button>
          <button type="submit" class="btn primary" [disabled]="disableSave">
            <span *ngIf="!isSaving">Save changes</span>
            <span *ngIf="isSaving">Saving…</span>
          </button>
        </div>
      </form>
    </section>

    <aside class="context-panel">
      <div class="profile-card glass">
        <div class="avatar-ring">
          <img [src]="avatarPreview" alt="Product image" (error)="onAvatarError($event)" />
        </div>
        <h3>{{ productForm.value.name || 'Unnamed product' }}</h3>
        <p class="description-preview">
          {{ productForm.value.description || 'No description provided' }}
        </p>
      </div>

      <div class="meta-card glass">
        <div class="meta-row">
          <span>Product ID</span>
          <strong>{{ productData?._id || productData?.id || '—' }}</strong>
        </div>
        <div class="meta-row">
          <span>Name</span>
          <strong>{{ productForm.value.name || '—' }}</strong>
        </div>
        <div class="meta-row">
          <span>Has features</span>
          <strong>{{ productForm.value.features ? 'Yes' : 'No' }}</strong>
        </div>
        <div class="meta-row">
          <span>Category</span>
          <strong>{{ selectedCategoryLabel }}</strong>
        </div>
        <button type="button" class="btn outline" (click)="refresh()">Refresh data</button>
      </div>

      <div class="danger-card glass">
        <div>
          <h3>Danger zone</h3>
          <p>Deleting a product removes it immediately.</p>
        </div>
        <button type="button" class="btn danger" (click)="deleteProduct()" [disabled]="isDeleting">
          <span *ngIf="!isDeleting">Delete product</span>
          <span *ngIf="isDeleting">Deleting…</span>
        </button>
      </div>
    </aside>
  </div>
</div>

