<section class="create-user-shell">
  <header class="page-header glass">
    <div>
      <p class="eyebrow">New Client</p>
      <h1>Add client user</h1>
      <p>Capture access credentials, contact details, and onboarding tasks in one responsive workspace.</p>
    </div>

    <div class="header-actions">
      <button type="button" class="ghost-btn" (click)="prefillDemoUser()" aria-label="Prefill demo data">
        Prefill demo data
      </button>
      <button type="button" class="ghost-btn" (click)="resetForm()" aria-label="Reset form">
        Reset form
      </button>
      <button type="button" class="back-btn" (click)="goBack()">
        Back to users
      </button>
    </div>
  </header>

  <div class="content-grid">
    <form class="create-form glass" [formGroup]="createForm" (ngSubmit)="submit()">
      <div class="form-progress" role="progressbar" [attr.aria-valuenow]="completionPercent" aria-valuemin="0" aria-valuemax="100">
        <div class="form-progress-bar" [style.width.%]="completionPercent"></div>
        <span>{{ completionPercent }}% complete</span>
      </div>

      <section class="form-panel">
        <div class="panel-header">
          <div>
            <p class="section-eyebrow">Server required</p>
            <h2>Credentials & access</h2>
            <p>We mirror the backend validation so the submission always succeeds on first try.</p>
          </div>
          <button type="button" class="mini-btn" (click)="applySuggestedUsername()">Suggest username</button>
        </div>

        <div class="fields-grid two-col">
          <div class="form-field">
            <label>Username <span>*</span></label>
            <input type="text" formControlName="username" placeholder="jane.doe" autocomplete="off" />
            <p class="field-hint">Whitespace trimmed server-side · must be unique.</p>
            <div class="field-error" *ngIf="controlInvalid('username')">
              {{ controlErrorMessage('username') }}
            </div>
          </div>

          <div class="form-field password-field">
            <label>Password <span>*</span></label>
            <input type="password" formControlName="password" placeholder="••••••••" autocomplete="new-password" />
            <div class="password-strength" [class]="passwordStrengthClass">
              {{ passwordStrengthLabel }}
            </div>
            <p class="field-hint">Backend rejects passwords shorter than 6 characters.</p>
            <div class="field-error" *ngIf="controlInvalid('password')">
              {{ controlErrorMessage('password') }}
            </div>
          </div>
        </div>
      </section>

      <section class="form-panel">
        <div class="panel-header">
          <div>
            <p class="section-eyebrow">Contact verification</p>
            <h2>Email & phone</h2>
            <p>Matches API regex, so the form blocks invalid formats before you submit.</p>
          </div>
        </div>

        <div class="fields-grid two-col">
          <div class="form-field">
            <label>Email <span>*</span></label>
            <input type="email" formControlName="email" placeholder="client@example.com" autocomplete="email" />
            <p class="field-hint">We normalize to lowercase to match the duplicate check on the server.</p>
            <div class="field-error" *ngIf="controlInvalid('email')">
              {{ controlErrorMessage('email') }}
            </div>
          </div>

          <div class="form-field">
            <label>Phone <span>*</span></label>
            <input type="tel" formControlName="phone" placeholder="+1 555 010 2000" (input)="handlePhoneInput($event)" />
            <p class="field-hint">API requires 8+ digits. We strip spaces before submitting.</p>
            <div class="field-error" *ngIf="controlInvalid('phone')">
              {{ controlErrorMessage('phone') }}
            </div>
          </div>
        </div>

        <div class="api-guidance">
          <strong>Server validation summary</strong>
          <ul class="rule-list">
            <li>Email must match <code>/^[^\s&#64;]+&#64;[^\s&#64;]+\.[^\s&#64;]+$/</code></li>
            <li>Phone shorter than 8 digits returns “Invalid phone number”</li>
            <li>Conflicts on username, email, or phone respond with HTTP 409</li>
          </ul>
        </div>
      </section>

      <section class="form-panel">
        <div class="panel-header">
          <div>
            <p class="section-eyebrow">Profile</p>
            <h2>Demographics</h2>
            <p>Gender helps personalize outreach. Role is fixed to Client user per API policy.</p>
          </div>
        </div>

        <div class="fields-grid two-col">
          <div class="form-field full-width">
            <label>Gender <span>*</span></label>
            <select formControlName="gender">
              <option value="">Select gender</option>
              <option *ngFor="let gender of genderOptions" [value]="gender">{{ gender }}</option>
            </select>
            <div class="field-error" *ngIf="controlInvalid('gender')">
              {{ controlErrorMessage('gender') }}
            </div>
          </div>
        </div>
      </section>

      <section class="form-panel">
        <div class="panel-header">
          <div>
            <p class="section-eyebrow">Optional</p>
            <h2>Avatar source</h2>
            <p>Provide a URL or upload a local image. If empty, the API falls back to the default avatar.</p>
          </div>
        </div>

        <div class="avatar-mode-toggle" role="tablist">
          <button
            type="button"
            role="tab"
            [class.active]="avatarInputMode === 'url'"
            (click)="setAvatarInputMode('url')">
            Use image URL
          </button>
          <button
            type="button"
            role="tab"
            [class.active]="avatarInputMode === 'upload'"
            (click)="setAvatarInputMode('upload')">
            Upload from device
          </button>
        </div>

        <div class="avatar-url" *ngIf="avatarInputMode === 'url'">
          <div class="form-field full-width">
            <label>Avatar URL</label>
            <input type="url" formControlName="avatar" placeholder="https://example.com/avatar.png" (input)="onAvatarUrlInput()" />
            <div class="avatar-suggestions">
              <span>Quick pick:</span>
              <button
                type="button"
                class="avatar-chip"
                *ngFor="let avatar of avatarSuggestions"
                (click)="useAvatarSuggestion(avatar)">
                <img [src]="avatar" alt="Avatar suggestion" />
              </button>
            </div>
          </div>
        </div>

        <div class="avatar-upload" *ngIf="avatarInputMode === 'upload'">
          <input
            #avatarInput
            type="file"
            accept="image/png, image/jpeg, image/webp"
            (change)="onAvatarFileChange($event)"
            hidden />
          <label
            class="upload-drop"
            [class.active]="isAvatarDropActive"
            (click)="openAvatarPicker(avatarInput)"
            (dragenter)="onAvatarDragEnter($event)"
            (dragover)="onAvatarDragOver($event)"
            (dragleave)="onAvatarDragLeave($event)"
            (drop)="onAvatarDrop($event)">
            <div class="upload-preview">
              <img [src]="avatarPreview" alt="Avatar preview" (error)="handleAvatarError($event)" />
            </div>
            <div class="upload-copy">
              <strong>Drop an image or click to browse</strong>
              <p>PNG, JPG or WEBP · up to {{ maxAvatarSizeMb }} MB</p>
              <span *ngIf="avatarFileName">{{ avatarFileName }} ready to upload</span>
            </div>
          </label>
          <div class="upload-controls">
            <button type="button" class="ghost-btn" (click)="openAvatarPicker(avatarInput)">Choose file</button>
            <button type="button" class="ghost-btn danger" (click)="clearAvatarSelection()" [disabled]="!createForm.get('avatar')?.value">
              Clear selection
            </button>
          </div>
          <p class="field-error" *ngIf="avatarUploadError">{{ avatarUploadError }}</p>
        </div>
      </section>

      <div class="form-alert error" *ngIf="serverError">
        {{ serverError }}
      </div>
      <div class="form-alert success" *ngIf="serverMessage">
        {{ serverMessage }}
        <span *ngIf="lastCreatedAt"> · {{ lastCreatedAt | date: 'shortTime' }}</span>
      </div>

      <footer class="form-actions">
        <button type="button" class="ghost-btn" (click)="goBack()">
          Cancel
        </button>
        <button type="submit" class="primary-btn" [disabled]="isSubmitting || createForm.invalid">
          {{ isSubmitting ? 'Creating user...' : 'Create user' }}
        </button>
      </footer>
    </form>

    <aside class="insights-panel">
      <div class="preview-card glass">
        <div class="preview-header">
          <p class="eyebrow">Live preview</p>
          <span class="status-chip">{{ selectedRoleLabel }}</span>
        </div>
        <div class="preview-body">
          <img
            [src]="avatarPreview"
            alt="Avatar preview"
            (error)="handleAvatarError($event)" />
          <div>
            <h3>{{ createForm.get('username')?.value || 'New client' }}</h3>
            <p>{{ createForm.get('email')?.value || 'Email pending' }}</p>
            <div class="mini-tags">
              <span>{{ createForm.get('gender')?.value || 'Gender TBD' }}</span>
              <span>{{ createForm.get('phone')?.value || 'Phone TBD' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="status-card glass">
        <div class="status-row">
          <span>Completion</span>
          <strong>{{ completionPercent }}%</strong>
        </div>
        <div class="progress-track">
          <div class="progress-fill" [style.width.%]="completionPercent"></div>
        </div>

        <div class="status-row">
          <span>Password strength</span>
          <strong class="strength-label" [class]="passwordStrengthClass">{{ passwordStrengthLabel }}</strong>
        </div>

        <div class="status-row">
          <span>API policy</span>
          <strong>Non-admin users only</strong>
        </div>
      </div>
    </aside>
  </div>
</section>