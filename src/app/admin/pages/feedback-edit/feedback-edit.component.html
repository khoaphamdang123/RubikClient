<div class="feedback-edit-shell">
  <div class="page-header glass">
    <div class="breadcrumbs">
      <button type="button" class="back-link" (click)="goBack()">← Back to feedback</button>
      <span>/</span>
      <span>Respond</span>
    </div>
    <div class="header-main">
      <div>
        <p class="eyebrow">Feedback management</p>
        <h1>Respond to feedback #{{ feedbackData?._id || feedbackId }}</h1>
        <p>
          Keep the same polished editing experience as user management while focusing solely on the client’s
          response.
        </p>
        <div class="quick-meta">
          <div>
            <span>Feedback ID</span>
            <strong>{{ feedbackData?._id || '—' }}</strong>
          </div>
          <div>
            <span>Category</span>
            <strong>{{ categoryLabel }}</strong>
          </div>
          <div>
            <span>Status</span>
            <strong class="status-chip-inline" [ngClass]="statusChipClass">{{ statusLabel }}</strong>
          </div>
          <div>
            <span>Last sync</span>
            <strong>{{ lastSyncedAt ? (lastSyncedAt | date: 'short') : 'Just now' }}</strong>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button type="button" class="btn ghost" (click)="resetResponse()" [disabled]="disableReset">
          Reset response
        </button>
        <button type="button" class="btn primary" (click)="saveResponse()" [disabled]="disableSave">
          <span *ngIf="!isSaving">Publish response</span>
          <span *ngIf="isSaving">Saving…</span>
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="state-card glass">
    <div class="loader"></div>
    <p>Loading feedback details…</p>
  </div>

  <div *ngIf="loadError && !isLoading" class="state-card glass error">
    <p>{{ loadError }}</p>
    <button type="button" class="btn primary" (click)="fetchFeedback()">Try again</button>
  </div>

  <div *ngIf="!isLoading && !loadError" class="content-grid">
    <div class="server-summary glass" *ngIf="serverMessage">
      <div>
        <p class="eyebrow">Server response</p>
        <h2>{{ serverMessage }}</h2>
        <p>The latest snapshot was pulled directly from the admin API.</p>
      </div>
      <div class="server-meta">
        <div>
          <span>Last sync</span>
          <strong>{{ lastSyncedAt ? (lastSyncedAt | date: 'medium') : 'Just now' }}</strong>
        </div>
        <div>
          <span>Status</span>
          <strong>{{ statusLabel }}</strong>
        </div>
      </div>
    </div>

    <section class="form-panel glass">
      <form [formGroup]="feedbackForm" (ngSubmit)="saveResponse()" novalidate>
        <div class="form-section">
          <div class="section-heading">
            <div>
              <p class="eyebrow">Submission</p>
              <h2>Feedback overview</h2>
              <p>Review all the metadata without switching screens.</p>
            </div>
            <button type="button" class="btn ghost slim" (click)="refresh()">Refresh data</button>
          </div>

          <div class="field-grid two">
            <label class="form-field">
              <span>Subject</span>
              <input type="text" formControlName="subject" placeholder="Subject" />
            </label>

            <label class="form-field">
              <span>Status</span>
              <input type="text" formControlName="status" placeholder="Status" />
            </label>
          </div>

          <div class="field-grid two">
            <label class="form-field">
              <span>Submitted by</span>
              <input type="text" formControlName="username" placeholder="User" />
            </label>

            <label class="form-field">
              <span>Email</span>
              <input type="text" formControlName="email" placeholder="Email" />
            </label>
          </div>

          <div class="field-grid two">
            <label class="form-field">
              <span>Category</span>
              <input type="text" formControlName="category" placeholder="Category" />
            </label>

            <label class="form-field">
              <span>Internal ID</span>
              <input type="text" [value]="feedbackData?._id || feedbackId" readonly />
            </label>
          </div>

          <label class="form-field span-2">
            <span>Original message</span>
            <textarea formControlName="feedback_content" rows="6"></textarea>
          </label>
        </div>

        <div class="form-section">
          <div class="section-heading">
            <div>
              <p class="eyebrow">Response</p>
              <h2>Compose your reply</h2>
              <p>Only this field is editable. Everything else stays locked for traceability.</p>
            </div>
          </div>

          <label class="form-field span-2">
            <span>Feedback response <sup>*</sup></span>
            <textarea
              formControlName="feedback_response"
              rows="6"
              placeholder="Share context, next steps, or a resolution..."
              [attr.maxLength]="maxResponseLength"></textarea>
            <div class="field-foot">
              <small *ngIf="responseControl?.invalid && responseControl?.touched">
                {{ responseControl?.errors?.['required'] ? 'A response is required.' : 'Please add more context.' }}
              </small>
              <span [class.warning]="responseCharactersLeft < 100">
                {{ responseCharactersLeft }} characters left
              </span>
            </div>
          </label>

          <div class="response-status" *ngIf="responseSubmitError || responseSubmitSuccess">
            <p class="status-error" *ngIf="responseSubmitError">{{ responseSubmitError }}</p>
            <p class="status-success" *ngIf="responseSubmitSuccess">{{ responseSubmitSuccess }}</p>
          </div>
        </div>

        <div class="form-actions mobile">
          <button type="button" class="btn ghost" (click)="resetResponse()" [disabled]="disableReset">
            Reset response
          </button>
          <button type="submit" class="btn primary" [disabled]="disableSave">
            <span *ngIf="!isSaving">Publish response</span>
            <span *ngIf="isSaving">Saving…</span>
          </button>
        </div>
      </form>
    </section>

    <aside class="context-panel">
      <div class="profile-card glass">
        <div class="avatar-ring">
          <span>{{ avatarInitial }}</span>
        </div>
        <h3>{{ displayUsername }}</h3>
        <p>{{ displayEmail }}</p>
        <span class="role-chip">{{ categoryLabel }}</span>
      </div>

      <div class="meta-card glass">
        <div class="meta-row">
          <span>Created</span>
          <strong>{{ formatDate(feedbackData?.created_date) }}</strong>
        </div>
        <div class="meta-row">
          <span>Updated</span>
          <strong>{{ formatDate(feedbackData?.updated_date) }}</strong>
        </div>
        <div class="meta-row">
          <span>Status</span>
          <strong>{{ statusLabel }}</strong>
        </div>
        <button type="button" class="btn outline" (click)="refresh()">Refresh data</button>
      </div>

      <div class="guidance-card glass">
        <h3>Response tips</h3>
        <ul>
          <li>Acknowledge the client’s situation.</li>
          <li>Outline actions and next steps.</li>
          <li>Set expectations for follow-up.</li>
        </ul>
      </div>
    </aside>
  </div>

